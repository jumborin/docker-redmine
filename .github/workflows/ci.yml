name: Docker Compose CI  # ワークフロー名

on:
  push: # 全ブランチへのpushで実行
  pull_request:
    branches: [ main ]  # mainブランチへのPR作成・更新時にも実行

jobs:
  docker-ci:
    runs-on: ubuntu-latest  # GitHubが用意するUbuntu仮想環境でジョブを実行

    steps:
      - name: Checkout repository  # リポジトリのソースコードを取得
        uses: actions/checkout@v4

      - name: Set up Docker Buildx  # Docker Buildxをセットアップ（ビルドの拡張機能）
        uses: docker/setup-buildx-action@v3

      - name: Build containers  # Docker Composeでコンテナをビルド
        run: docker compose build --no-cache

      - name: Run containers  # Docker Composeでコンテナを起動
        run: |
          docker compose up -d
          docker compose ps

      - name: Wait for containers  # コンテナの起動を待機
        run: |
          echo "Waiting for MySQL container..."
          MYSQL_TIMEOUT=120
          MYSQL_COUNT=0
          until docker exec docker-redmine-mysql-1 mysqladmin ping -h localhost --silent; do
            sleep 5
            MYSQL_COUNT=$((MYSQL_COUNT + 5))
            if [ $MYSQL_COUNT -ge $MYSQL_TIMEOUT ]; then
              echo "MySQL startup timeout after ${MYSQL_TIMEOUT} seconds"
              docker ps
              docker logs docker-redmine-mysql-1
              exit 1
            fi
          done
          echo "MySQL is ready!"
          
          echo "Waiting for Redmine container..."
          REDMINE_TIMEOUT=600
          REDMINE_COUNT=0
          until docker exec docker-redmine-redmine-1 supervisorctl status puma | grep RUNNING > /dev/null; do
            sleep 5
            REDMINE_COUNT=$((REDMINE_COUNT + 5))
            if [ $REDMINE_COUNT -ge $REDMINE_TIMEOUT ]; then
              echo "Redmine startup timeout after ${REDMINE_TIMEOUT} seconds"
              docker ps
              docker logs docker-redmine-redmine-1
              exit 1
            fi
          done
          echo "Redmine is ready!"
          
          echo "Waiting for Nginx container..."
          NGINX_TIMEOUT=300
          NGINX_COUNT=0
          until curl -f http://localhost/login > /dev/null 2>&1; do
            sleep 5
            NGINX_COUNT=$((NGINX_COUNT + 5))
            if [ $NGINX_COUNT -ge $NGINX_TIMEOUT ]; then
              echo "Nginx startup timeout after ${NGINX_TIMEOUT} seconds"
              docker ps
              echo "=== Nginx Logs ==="
              docker logs docker-redmine-nginx-1
              echo "=== Redmine Logs (last 50 lines) ==="
              docker logs docker-redmine-redmine-1 --tail 50
              echo "=== Testing Nginx -> Redmine connection ==="
              docker exec docker-redmine-nginx-1 curl -v http://redmine:3000 || true
              exit 1
            fi
          done
          echo "Nginx is ready!"
          docker compose ps

      - name: Install Plugins  # プラグインのインストール
        run: |
          docker exec docker-redmine-redmine-1 gosu redmine git clone -b v1.2.0 --depth 1 https://github.com/redmica/redmine_issues_panel.git ../data/plugins/redmine_issues_panel
          docker exec docker-redmine-redmine-1 gosu redmine git clone -b 1.2.0 --depth 1 https://github.com/haru/redmine_wiki_extensions.git ../data/plugins/redmine_wiki_extensions
          docker exec docker-redmine-redmine-1 gosu redmine git clone -b v3.5.4 --depth 1 https://github.com/onozaty/redmine-view-customize.git ../data/plugins/view_customize
          docker exec docker-redmine-redmine-1 gosu redmine git clone -b v4.0.4 --depth 1 https://github.com/xelkano/redmine_xapian.git ../data/plugins/redmine_xapian
          docker exec docker-redmine-redmine-1 gosu redmine git clone -b v1.2.0 --depth 1 https://github.com/redmica/redmine_issues_panel.git plugins/redmine_issues_panel
          docker exec docker-redmine-redmine-1 gosu redmine git clone -b 1.2.0 --depth 1 https://github.com/haru/redmine_wiki_extensions.git plugins/redmine_wiki_extensions
          docker exec docker-redmine-redmine-1 gosu redmine git clone -b v3.5.4 --depth 1 https://github.com/onozaty/redmine-view-customize.git plugins/view_customize
          docker exec docker-redmine-redmine-1 gosu redmine git clone -b v4.0.4 --depth 1 https://github.com/xelkano/redmine_xapian.git plugins/redmine_xapian
          docker exec docker-redmine-redmine-1 gosu redmine bundle config set --local without development test
          docker exec docker-redmine-redmine-1 gosu redmine bundle install --local --no-cache
          docker exec docker-redmine-redmine-1 gosu redmine bundle exec rake redmine:plugins:migrate RAILS_ENV=production
          docker exec docker-redmine-redmine-1 gosu redmine bundle exec rake assets:precompile RAILS_ENV=production
          docker exec docker-redmine-redmine-1 ruby /home/redmine/redmine/plugins/redmine_xapian/extra/xapian_indexer.rb -v
          docker exec docker-redmine-redmine-1 supervisorctl restart puma
          sleep 30

      - name: Check redmine containers  # Redmineコンテナの内容確認
        run: |
          docker exec docker-redmine-redmine-1 cat /etc/os-release
          docker exec docker-redmine-redmine-1 mysql -V
          docker exec docker-redmine-redmine-1 nginx -v
          docker exec docker-redmine-redmine-1 ruby /home/redmine/redmine/bin/about
          echo "=== Redmine Container Timezone ==="
          docker exec docker-redmine-redmine-1 date
          docker exec docker-redmine-redmine-1 cat /etc/localtime | head -c 4
          echo ""
          tree volumes/redmine_data/tmp/bundle/ruby -L 3
          ls -l volumes/redmine_data/tmp/bundle/ruby/3.3.0/cache/
          ls -l volumes/redmine_data/tmp/bundle/ruby/3.3.0/gems/

      - name: Check mysql containers  # MySQLコンテナの内容確認
        run: |
          docker exec docker-redmine-mysql-1 mysql -V
          docker exec docker-redmine-mysql-1 cat /etc/os-release
          echo "=== MySQL Container Timezone ==="
          docker exec docker-redmine-mysql-1 date
          docker exec docker-redmine-mysql-1 mysql -uredmine -ppassword -e "SELECT NOW(), @@system_time_zone, @@time_zone;"
          echo "=== MySQL Configuration ==="
          docker exec docker-redmine-mysql-1 mysql -uredmine -ppassword -e "SHOW VARIABLES LIKE 'lower_case_table_names';"
          docker exec docker-redmine-mysql-1 mysql -uredmine -ppassword -e "SHOW VARIABLES LIKE 'character_set%';"
          docker exec docker-redmine-mysql-1 mysql -uredmine -ppassword -e "SHOW VARIABLES LIKE 'collation%';"

      - name: Setup Node.js for Playwright  # Playwright用のNode.js環境をセットアップ
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright  # Playwrightをインストール
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium

      - name: Take screenshot  # Redmineアプリのスクリーンショットを取得
        run: |
          mkdir -p screenshots
          cat > screenshot.js << 'EOF'
          const { chromium } = require('playwright');
          
          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            
            try {
              // Redmineのログインページにアクセスし、スクリーンショットを取得
              await page.goto('http://localhost/login', { waitUntil: 'networkidle' });
              await page.screenshot({ path: 'screenshots/redmine-login.png', fullPage: true });
              console.log('Login page screenshot saved');
              
              // ログイン画面でログイン情報を入力してログイン
              await page.fill('#username', 'admin');
              await page.fill('#password', 'admin');
              await Promise.all([
                page.waitForNavigation({ waitUntil: 'networkidle', timeout: 60000 }),
                page.click('input[type="submit"]')
              ]);
              
              // 初回ログイン時のパスワード変更画面のスクリーンショットを取得
              await page.screenshot({ path: 'screenshots/redmine-password-page.png', fullPage: true });
              console.log('Password change page screenshot saved');
              
              // パスワード変更画面でパスワードを変更
              await page.fill('#password', 'admin');
              await page.fill('#new_password', 'newpassword123');
              await page.fill('#new_password_confirmation', 'newpassword123');
              await Promise.all([
                page.waitForNavigation({ waitUntil: 'networkidle', timeout: 60000 }),
                page.click('input[type="submit"]')
              ]);

              // パスワード変更後の個人設定画面のスクリーンショットを取得
              await page.screenshot({ path: 'screenshots/redmine-password-changed.png', fullPage: true });
              console.log('Password changed screenshot saved');

              // プラグイン一覧ページにアクセスし、スクリーンショットを取得
              await page.goto('http://localhost/admin/plugins', { waitUntil: 'networkidle' });
              await page.screenshot({ path: 'screenshots/redmine-plugins.png', fullPage: true });
              console.log('Plugins page screenshot saved');

              // 情報ページにアクセスし、スクリーンショットを取得
              await page.goto('http://localhost/admin/info', { waitUntil: 'networkidle' });
              await page.screenshot({ path: 'screenshots/redmine-info.png', fullPage: true });
              console.log('Info page screenshot saved');

              // 詳細検索ページにアクセスし、スクリーンショットを取得
              await page.goto('http://localhost/search', { waitUntil: 'networkidle' });
              await page.screenshot({ path: 'screenshots/redmine-search.png', fullPage: true });
              console.log('Search page screenshot saved');

            } catch (error) {
              console.error('Error taking screenshot:', error);
              await page.screenshot({ path: 'screenshots/redmine-error.png', fullPage: true });
              process.exit(1);
            } finally {
              await browser.close();
            }
          })();
          EOF
          node screenshot.js

      - name: Upload screenshot  # スクリーンショットをアーティファクトとしてアップロード
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: redmine-screenshots
          path: screenshots/
          retention-days: 30

      - name: Shut down containers  # コンテナを停止・削除
        run: |
          docker compose ps
          docker compose down
          docker compose ps
